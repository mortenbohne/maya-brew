name: Build & Publish Docker (GHCR)

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  docker:
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ github.repository_owner }}/maya-brew
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf31f7 # v4.1.7
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Build & Push
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          docker buildx build \
            -t "${IMAGE}:latest" \
            -t "${IMAGE}:sha-${SHORT_SHA}" \
            --push \
            .
          echo "SHORT_SHA=${SHORT_SHA}" >> "$GITHUB_ENV"

      - name: Summary
        run: |
          set -euo pipefail
          SHORT_SHA="${SHORT_SHA:-${GITHUB_SHA::7}}"
          {
            echo "Published tags:"
            echo "${IMAGE}:latest"
            echo "${IMAGE}:sha-${SHORT_SHA}"
          } | tee -a "$GITHUB_STEP_SUMMARY"
